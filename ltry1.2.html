<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Lottery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3838);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: #ffd700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .lottery-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .info-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-accepting { background: #28a745; }
        .status-revealing { background: #ffc107; color: #000; }
        .status-selecting { background: #17a2b8; }
        .status-completed { background: #6f42c1; }
        .status-cancelled { background: #dc3545; }

        .participants-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .participant-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .winner-announcement {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .winner-announcement h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
            margin: 15px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success { background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; }
        .alert-danger { background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; }
        .alert-warning { background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #000; }
        .alert-info { background: rgba(23, 162, 184, 0.2); border: 1px solid #17a2b8; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🎰 Decentralized Lottery</h1>
            <p>Fair, Transparent, Blockchain-Powered</p>
        </header>

        <!-- Wallet Connection -->
        <div class="wallet-section">
            <div id="wallet-disconnected">
                <button class="btn" onclick="connectWallet()">Connect Wallet</button>
                <p style="margin-top: 10px; opacity: 0.8;">Connect your wallet to participate in the lottery</p>
            </div>
            <div id="wallet-connected" class="hidden">
                <p><strong>Connected:</strong> <span id="wallet-address"></span></p>
                <p><strong>Balance:</strong> <span id="wallet-balance"></span> ETH</p>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alert-container"></div>

        <!-- Owner Controls -->
        <div id="owner-controls" class="card hidden">
            <h3>🔑 Owner Controls</h3>
            <div class="form-group">
                <label>Entry Fee (ETH):</label>
                <input type="number" id="entry-fee" placeholder="0.01" min="0.01" max="10" step="0.01">
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="startNewLottery()">Start New Lottery</button>
                <button class="btn btn-danger" onclick="cancelLottery()">Cancel Current Lottery</button>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="withdrawPlatformFees()">Withdraw Platform Fees</button>
                <button class="btn btn-secondary" onclick="pauseContract()">Pause Contract</button>
            </div>
        </div>

        <!-- Current Lottery Info -->
        <div class="lottery-info">
            <h2 style="text-align: center; margin-bottom: 25px;">Current Lottery Status</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">Round ID</div>
                    <div class="value" id="current-round">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Status</div>
                    <div class="value" id="lottery-status">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Entry Fee</div>
                    <div class="value" id="entry-fee-display">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Total Pot</div>
                    <div class="value" id="total-pot">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Participants</div>
                    <div class="value" id="participant-count">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Time Remaining</div>
                    <div class="value countdown" id="time-remaining">-</div>
                </div>
            </div>
        </div>

        <!-- Winner Announcement -->
        <div id="winner-announcement" class="winner-announcement hidden">
            <h2>🏆 We have a Winner!</h2>
            <p><strong>Winner:</strong> <span id="winner-address"></span></p>
            <p><strong>Prize:</strong> <span id="winner-amount"></span> ETH</p>
        </div>

        <!-- Action Cards -->
        <div class="cards-grid">
            <!-- Enter Lottery -->
            <div class="card" id="enter-lottery-card">
                <h3>🎫 Enter Lottery</h3>
                <div class="form-group">
                    <label>Secret Number:</label>
                    <input type="number" id="secret-number" placeholder="Enter a secret number">
                </div>
                <div class="form-group">
                    <label>Nonce:</label>
                    <input type="number" id="nonce" placeholder="Enter a random nonce">
                </div>
                <button class="btn" onclick="generateCommitment()">Generate Commitment</button>
                <div id="commitment-display" class="hidden" style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <strong>Your Commitment:</strong>
                    <div id="commitment-hash" style="word-break: break-all; font-family: monospace;"></div>
                </div>
                <button class="btn" id="enter-lottery-btn" onclick="enterLottery()" disabled>Enter Lottery</button>
            </div>

            <!-- Reveal Secret -->
            <div class="card" id="reveal-secret-card">
                <h3>🔓 Reveal Secret</h3>
                <p style="margin-bottom: 15px;">Reveal your secret after the entry period ends</p>
                <div class="form-group">
                    <label>Your Secret Number:</label>
                    <input type="number" id="reveal-secret" placeholder="Enter your secret">
                </div>
                <div class="form-group">
                    <label>Your Nonce:</label>
                    <input type="number" id="reveal-nonce" placeholder="Enter your nonce">
                </div>
                <button class="btn btn-secondary" onclick="revealSecret()">Reveal Secret</button>
            </div>

            <!-- Lottery Actions -->
            <div class="card">
                <h3>⚡ Lottery Actions</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="selectWinner()">Select Winner</button>
                    <p style="font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">
                        Advances lottery phases and selects winner when ready
                    </p>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="distributeFunds()">Distribute Funds</button>
                    <p style="font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">
                        Send winnings to the selected winner
                    </p>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="refreshLotteryInfo()">Refresh Info</button>
                    <p style="font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">
                        Update lottery status and countdown
                    </p>
                </div>
                <div class="alert alert-info" style="margin-top: 15px; font-size: 0.9rem;">
                    <strong>Note:</strong> If entry time has ended but you can't reveal secrets, click "Select Winner" to advance the lottery phase.
                </div>
            </div>
        </div>

        <!-- Participants List -->
        <div class="participants-section">
            <h3>👥 Participants</h3>
            <div id="participants-list">
                <p>No participants yet...</p>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0xdf0473dd91432aa5ab98dbde9f3fe5e03da7ef49"; // Replace with your deployed contract address
        const CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_reason",
				"type": "string"
			}
		],
		"name": "cancelLottery",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "distributeFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_commitment",
				"type": "bytes32"
			}
		],
		"name": "enterLottery",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "participant",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EntrySubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "winnerAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "platformFee",
				"type": "uint256"
			}
		],
		"name": "FundsDistributed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "reason",
				"type": "string"
			}
		],
		"name": "LotteryCancelled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "entryFee",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "entryDeadline",
				"type": "uint256"
			}
		],
		"name": "LotteryStarted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "pause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Paused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "participant",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RefundIssued",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_roundId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_participant",
				"type": "address"
			}
		],
		"name": "refundParticipant",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_secret",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_nonce",
				"type": "uint256"
			}
		],
		"name": "revealSecret",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "participant",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "secret",
				"type": "uint256"
			}
		],
		"name": "SecretRevealed",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "selectWinner",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_entryFee",
				"type": "uint256"
			}
		],
		"name": "startNewLottery",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "unpause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Unpaused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "WinnerSelected",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "withdrawPlatformFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "currentRoundId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "ENTRY_DURATION",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "lotteryRounds",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalPot",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "entryFee",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "startTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "entryDeadline",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "revealDeadline",
				"type": "uint256"
			},
			{
				"internalType": "address payable",
				"name": "winner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "winningAmount",
				"type": "uint256"
			},
			{
				"internalType": "enum DecentralizedLottery.LotteryState",
				"name": "state",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "participantCount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "fundsDistributed",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "MAX_ENTRY_FEE",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "MIN_ENTRY_FEE",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "participants",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "wallet",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "entryAmount",
				"type": "uint256"
			},
			{
				"internalType": "bytes32",
				"name": "commitment",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "revealedSecret",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "hasRevealed",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "entryTime",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "PLATFORM_FEE_PERCENT",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "platformBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "REVEAL_DURATION",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "revealedSecrets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "roundParticipants",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;
        let isOwner = false;
        let countdownInterval;

        // Lottery states
        const LOTTERY_STATES = {
            0: { name: "ACCEPTING_ENTRIES", class: "status-accepting" },
            1: { name: "REVEALING_PHASE", class: "status-revealing" },
            2: { name: "SELECTING_WINNER", class: "status-selecting" },
            3: { name: "COMPLETED", class: "status-completed" },
            4: { name: "CANCELLED", class: "status-cancelled" }
        };

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showAlert('Please install MetaMask!', 'danger');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Update UI
                document.getElementById('wallet-disconnected').classList.add('hidden');
                document.getElementById('wallet-connected').classList.remove('hidden');
                document.getElementById('wallet-address').textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);

                // Get balance
                const balance = await provider.getBalance(userAddress);
                document.getElementById('wallet-balance').textContent = ethers.utils.formatEther(balance);

                // Check if user is owner
                try {
                    const owner = await contract.owner();
                    isOwner = owner.toLowerCase() === userAddress.toLowerCase();
                    if (isOwner) {
                        document.getElementById('owner-controls').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error checking owner:', error);
                }

                showAlert('Wallet connected successfully!', 'success');
                await refreshLotteryInfo();

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        location.reload();
                    }
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Error connecting wallet: ' + error.message, 'danger');
            }
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Generate commitment hash
        function generateCommitment() {
            const secret = document.getElementById('secret-number').value;
            const nonce = document.getElementById('nonce').value;

            if (!secret || !nonce) {
                showAlert('Please enter both secret number and nonce', 'warning');
                return;
            }

            const commitment = ethers.utils.keccak256(
                ethers.utils.defaultAbiCoder.encode(['uint256', 'uint256'], [secret, nonce])
            );

            document.getElementById('commitment-hash').textContent = commitment;
            document.getElementById('commitment-display').classList.remove('hidden');
            document.getElementById('enter-lottery-btn').disabled = false;

            showAlert('Commitment generated! Save your secret and nonce safely.', 'success');
        }

        // Start new lottery (owner only)
        async function startNewLottery() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            const entryFee = document.getElementById('entry-fee').value;
            if (!entryFee || entryFee < 0.001 || entryFee > 10) {
                showAlert('Entry fee must be between 0.001 and 10 ETH', 'warning');
                return;
            }

            try {
                const tx = await contract.startNewLottery(ethers.utils.parseEther(entryFee));
                showAlert('Starting new lottery...', 'info');
                await tx.wait();
                showAlert('New lottery started successfully!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error starting lottery:', error);
                showAlert('Error starting lottery: ' + error.message, 'danger');
            }
        }

        // Enter lottery
        async function enterLottery() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            const commitment = document.getElementById('commitment-hash').textContent;
            if (!commitment) {
                showAlert('Please generate commitment first', 'warning');
                return;
            }

            try {
                const currentRound = await contract.currentRoundId();
                const roundInfo = await contract.lotteryRounds(currentRound);
                const entryFee = roundInfo.entryFee;

                const tx = await contract.enterLottery(commitment, { value: entryFee });
                showAlert('Entering lottery...', 'info');
                await tx.wait();
                showAlert('Successfully entered the lottery!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error entering lottery:', error);
                showAlert('Error entering lottery: ' + error.message, 'danger');
            }
        }

        // Reveal secret
        async function revealSecret() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            const secret = document.getElementById('reveal-secret').value;
            const nonce = document.getElementById('reveal-nonce').value;

            if (!secret || !nonce) {
                showAlert('Please enter both secret and nonce', 'warning');
                return;
            }

            try {
                // First check if we need to trigger state transition
                const currentRound = await contract.currentRoundId();
                const roundInfo = await contract.lotteryRounds(currentRound);
                const now = Math.floor(Date.now() / 1000);

                // If entry period has ended but still in ACCEPTING_ENTRIES state, trigger transition
                if (roundInfo.state === 0 && now > roundInfo.entryDeadline.toNumber()) {
                    showAlert('Entry period ended. Triggering state transition...', 'info');
                    // Call revealSecret which will trigger the state transition in the contract
                }

                const tx = await contract.revealSecret(secret, nonce);
                showAlert('Revealing secret...', 'info');
                await tx.wait();
                showAlert('Secret revealed successfully!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error revealing secret:', error);
                
                // Check if the error is due to state transition needed
                if (error.message.includes('Not in reveal phase')) {
                    showAlert('Entry period just ended. Please try again in a few seconds or call "Select Winner" to advance the lottery state.', 'warning');
                } else {
                    showAlert('Error revealing secret: ' + error.message, 'danger');
                }
            }
        }

        // Select winner
        async function selectWinner() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            try {
                // Check current state and provide helpful message
                const currentRound = await contract.currentRoundId();
                const roundInfo = await contract.lotteryRounds(currentRound);
                const now = Math.floor(Date.now() / 1000);

                if (roundInfo.state === 0 && now > roundInfo.entryDeadline.toNumber()) {
                    showAlert('Advancing lottery to reveal phase and then selecting winner...', 'info');
                } else if (roundInfo.state === 1 && now > roundInfo.revealDeadline.toNumber()) {
                    showAlert('Reveal phase ended. Selecting winner...', 'info');
                } else if (roundInfo.state === 2) {
                    showAlert('Selecting winner...', 'info');
                } else {
                    showAlert('Cannot select winner yet. Check the lottery phase and timing.', 'warning');
                    return;
                }

                const tx = await contract.selectWinner();
                await tx.wait();
                showAlert('Winner selected successfully!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error selecting winner:', error);
                
                if (error.message.includes('Cannot select winner yet')) {
                    showAlert('Cannot select winner yet. Wait for the appropriate phase.', 'warning');
                } else if (error.message.includes('No participants')) {
                    showAlert('No participants in the lottery yet.', 'warning');
                } else if (error.message.includes('No valid participants')) {
                    showAlert('No valid participants (no one revealed their secret).', 'warning');
                } else {
                    showAlert('Error selecting winner: ' + error.message, 'danger');
                }
            }
        }

        // Distribute funds
        async function distributeFunds() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            try {
                const tx = await contract.distributeFunds();
                showAlert('Distributing funds...', 'info');
                await tx.wait();
                showAlert('Funds distributed successfully!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error distributing funds:', error);
                showAlert('Error distributing funds: ' + error.message, 'danger');
            }
        }

        // Cancel lottery (owner only)
        async function cancelLottery() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            const reason = prompt("Enter cancellation reason:");
            if (!reason) return;

            try {
                const tx = await contract.cancelLottery(reason);
                showAlert('Cancelling lottery...', 'info');
                await tx.wait();
                showAlert('Lottery cancelled successfully!', 'success');
                await refreshLotteryInfo();
            } catch (error) {
                console.error('Error cancelling lottery:', error);
                showAlert('Error cancelling lottery: ' + error.message, 'danger');
            }
        }

        // Withdraw platform fees (owner only)
        async function withdrawPlatformFees() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            try {
                const tx = await contract.withdrawPlatformFees();
                showAlert('Withdrawing platform fees...', 'info');
                await tx.wait();
                showAlert('Platform fees withdrawn successfully!', 'success');
            } catch (error) {
                console.error('Error withdrawing fees:', error);
                showAlert('Error withdrawing fees: ' + error.message, 'danger');
            }
        }

        // Pause contract (owner only)
        async function pauseContract() {
            if (!contract) {
                showAlert('Please connect your wallet first', 'warning');
                return;
            }

            try {
                const tx = await contract.pause();
                showAlert('Pausing contract...', 'info');
                await tx.wait();
                showAlert('Contract paused successfully!', 'success');
            } catch (error) {
                console.error('Error pausing contract:', error);
                showAlert('Error pausing contract: ' + error.message, 'danger');
            }
        }

        // Refresh lottery information
        async function refreshLotteryInfo() {
            if (!contract) return;

            try {
                const currentRound = await contract.currentRoundId();
                document.getElementById('current-round').textContent = currentRound.toString();

                if (currentRound.gt(0)) {
                    const roundInfo = await contract.lotteryRounds(currentRound);
                    
                    // Update lottery info
                    document.getElementById('entry-fee-display').textContent = ethers.utils.formatEther(roundInfo.entryFee) + ' ETH';
                    document.getElementById('total-pot').textContent = ethers.utils.formatEther(roundInfo.totalPot) + ' ETH';
                    document.getElementById('participant-count').textContent = roundInfo.participantCount.toString();

                    // Update status
                    const state = LOTTERY_STATES[roundInfo.state];
                    document.getElementById('lottery-status').innerHTML = `<span class="status-badge ${state.class}">${state.name}</span>`;

                    // Update countdown
                    updateCountdown(roundInfo);

                    // Auto-refresh more frequently when near phase transitions
                    const now = Math.floor(Date.now() / 1000);
                    const nearEntryDeadline = Math.abs(now - roundInfo.entryDeadline.toNumber()) < 30;
                    const nearRevealDeadline = Math.abs(now - roundInfo.revealDeadline.toNumber()) < 30;
                    
                    if (nearEntryDeadline || nearRevealDeadline) {
                        // Refresh more frequently when near deadlines
                        setTimeout(() => {
                            if (contract) refreshLotteryInfo();
                        }, 5000);
                    }

                    // Show winner if completed
                    if (roundInfo.state === 3 && roundInfo.winner !== ethers.constants.AddressZero) {
                        document.getElementById('winner-announcement').classList.remove('hidden');
                        document.getElementById('winner-address').textContent = roundInfo.winner;
                        document.getElementById('winner-amount').textContent = ethers.utils.formatEther(roundInfo.winningAmount);
                    } else {
                        document.getElementById('winner-announcement').classList.add('hidden');
                    }
                } else {
                    document.getElementById('lottery-status').innerHTML = '<span class="status-badge">No Active Lottery</span>';
                    document.getElementById('time-remaining').textContent = 'N/A';
                }

            } catch (error) {
                console.error('Error refreshing lottery info:', error);
            }
        }

        // Update countdown timer
        function updateCountdown(roundInfo) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                let deadline;
                let phase;

                if (roundInfo.state === 0) { // ACCEPTING_ENTRIES
                    deadline = roundInfo.entryDeadline.toNumber();
                    phase = "Entry deadline";
                } else if (roundInfo.state === 1) { // REVEALING_PHASE
                    deadline = roundInfo.revealDeadline.toNumber();
                    phase = "Reveal deadline";
                } else {
                    document.getElementById('time-remaining').textContent = 'N/A';
                    clearInterval(countdownInterval);
                    return;
                }

                const timeLeft = deadline - now;
                if (timeLeft > 0) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    
                    // Show format appropriate for the time duration
                    if (timeLeft >= 3600) { // If more than 1 hour, show hours
                        const hours = Math.floor(timeLeft / 3600);
                        document.getElementById('time-remaining').textContent = 
                            `${hours}h ${minutes % 60}m ${seconds}s`;
                    } else {
                        document.getElementById('time-remaining').textContent = 
                            `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
                    }
                } else {
                    document.getElementById('time-remaining').textContent = 'Expired';
                    clearInterval(countdownInterval);
                    refreshLotteryInfo(); // Refresh to update state
                }
            }, 1000);
        }

        // Initialize app
        window.addEventListener('load', async () => {
            // Check if wallet is already connected
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Error checking wallet connection:', error);
                }
            }

            // Refresh lottery info every 30 seconds
            setInterval(() => {
                if (contract) {
                    refreshLotteryInfo();
                }
            }, 30000);
        });

        // Event listeners for contract events
        function setupEventListeners() {
            if (!contract) return;

            contract.on("LotteryStarted", (roundId, entryFee, entryDeadline) => {
                showAlert(`New lottery started! Round ${roundId.toString()}`, 'success');
                refreshLotteryInfo();
            });

            contract.on("EntrySubmitted", (roundId, participant, amount) => {
                if (participant.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert('Your entry has been confirmed!', 'success');
                }
                refreshLotteryInfo();
            });

            contract.on("SecretRevealed", (roundId, participant, secret) => {
                if (participant.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert('Your secret has been revealed!', 'success');
                }
                refreshLotteryInfo();
            });

            contract.on("WinnerSelected", (roundId, winner, amount) => {
                showAlert(`Winner selected for Round ${roundId.toString()}!`, 'success');
                if (winner.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert('🎉 Congratulations! You won the lottery!', 'success');
                }
                refreshLotteryInfo();
            });

            contract.on("FundsDistributed", (roundId, winner, winnerAmount, platformFee) => {
                showAlert(`Funds distributed for Round ${roundId.toString()}!`, 'success');
                refreshLotteryInfo();
            });
        }

        // Call setupEventListeners after contract is initialized
        // Add this to the connectWallet function after contract initialization
        // setupEventListeners();
    </script>